<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>League of Learning</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        display: ['Cinzel', 'serif'],
                        body: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        gold: {
                            100: '#F9F1D8',
                            300: '#E8D48F',
                            500: '#D4AF37',
                            700: '#AA8C2C',
                            900: '#78621D',
                        },
                        slate: {
                            850: '#151F2E',
                            900: '#0F172A',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; }
        
        .text-gradient-gold {
            background: linear-gradient(to right, #D4AF37, #F9F1D8, #D4AF37);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: shine 4s linear infinite;
        }
        .bg-gradient-gold {
            background: linear-gradient(135deg, #AA8C2C 0%, #D4AF37 50%, #F9F1D8 100%);
        }
        @keyframes shine { to { background-position: 200% center; } }

        .house-btn { transition: all 0.3s ease; }
        .house-selected-Ashton { background-color: #ef4444; color: white; border-color: #ef4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }
        .house-selected-Brielle { background-color: #3b82f6; color: white; border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .house-selected-Carter { background-color: #22c55e; color: white; border-color: #22c55e; box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); }
        .house-selected-Dominique { background-color: #eab308; color: white; border-color: #eab308; box-shadow: 0 0 15px rgba(234, 179, 8, 0.4); }

        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .pulse-gold {
            box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7);
            animation: pulse-gold-anim 2s infinite;
        }
        @keyframes pulse-gold-anim {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(212, 175, 55, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="text-gray-200">

    <div class="max-w-md mx-auto min-h-screen bg-slate-950 shadow-2xl relative overflow-hidden flex flex-col border-x border-slate-800">
        
        <!-- Header -->
        <div class="px-6 py-4 z-20 flex justify-between items-center bg-slate-950/80 backdrop-blur-md border-b border-white/10 sticky top-0">
            <div>
                <h1 class="font-display font-bold text-xl tracking-wider text-gradient-gold">LEAGUE OF LEARNING</h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest">Est. 2024</p>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleStats()" class="p-2 rounded-full hover:bg-white/5 transition group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 group-hover:text-gold-300 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </button>
                <button onclick="toggleLeaderboard()" class="p-2 rounded-full hover:bg-white/5 transition group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gold-500 group-hover:text-gold-300 transition" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5 2a1 1 0 011-1h8a1 1 0 011 1v1h1a2 2 0 012 2v2a2 2 0 01-2 2h-1c-.5 2.5-2.5 4.5-5 5v2h2a1 1 0 110 2H8a1 1 0 110-2h2v-2c-2.5-.5-4.5-2.5-5-5H4a2 2 0 01-2-2V4a2 2 0 012-2h1V2zm1 1v2h8V3H6zm10 2h1v2h-1V5zM4 5v2h1V5H4z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- VIEW: PROFILE SETUP -->
        <div id="view-profile" class="flex-1 p-8 flex flex-col justify-center space-y-8 hidden">
            <div class="text-center">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-slate-800 to-slate-900 border border-gold-700/30 flex items-center justify-center mx-auto mb-6 shadow-[0_0_30px_rgba(212,175,55,0.1)]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gold-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </div>
                <h2 class="font-display text-2xl font-bold text-white mb-2">Initiate Profile</h2>
                <p class="text-gray-400 text-xs uppercase tracking-widest">Identify yourself, Scholar</p>
            </div>

            <form id="profileForm" onsubmit="saveProfile(event)" class="space-y-5">
                <div>
                    <input type="text" id="inputName" required class="w-full bg-slate-900/50 border border-slate-700 text-white px-4 py-3 rounded-lg focus:border-gold-500 focus:ring-1 focus:ring-gold-500 outline-none transition placeholder-gray-600 text-sm" placeholder="FULL NAME">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="inputClass" required class="w-full bg-slate-900/50 border border-slate-700 text-white px-4 py-3 rounded-lg focus:border-gold-500 focus:ring-1 focus:ring-gold-500 outline-none transition placeholder-gray-600 text-sm" placeholder="CLASS (e.g. 5A)">
                    <input type="number" id="inputClassNo" required class="w-full bg-slate-900/50 border border-slate-700 text-white px-4 py-3 rounded-lg focus:border-gold-500 focus:ring-1 focus:ring-gold-500 outline-none transition placeholder-gray-600 text-sm" placeholder="NO. (e.g. 12)">
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-gold-500 uppercase tracking-widest mb-3 text-center">Select House Allegiance</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" onclick="selectHouse('Ashton')" id="btn-Ashton" class="house-btn border border-slate-700 bg-slate-900/50 rounded-lg py-3 text-xs font-semibold transition hover:bg-slate-800 house-Ashton">ASHTON</button>
                        <button type="button" onclick="selectHouse('Brielle')" id="btn-Brielle" class="house-btn border border-slate-700 bg-slate-900/50 rounded-lg py-3 text-xs font-semibold transition hover:bg-slate-800 house-Brielle">BRIELLE</button>
                        <button type="button" onclick="selectHouse('Carter')" id="btn-Carter" class="house-btn border border-slate-700 bg-slate-900/50 rounded-lg py-3 text-xs font-semibold transition hover:bg-slate-800 house-Carter">CARTER</button>
                        <button type="button" onclick="selectHouse('Dominique')" id="btn-Dominique" class="house-btn border border-slate-700 bg-slate-900/50 rounded-lg py-3 text-xs font-semibold transition hover:bg-slate-800 house-Dominique">DOMINIQUE</button>
                    </div>
                    <input type="hidden" id="inputHouse" required>
                </div>

                <button type="submit" class="w-full mt-6 bg-gradient-gold text-slate-900 font-display font-bold py-4 rounded-lg shadow-[0_0_20px_rgba(212,175,55,0.3)] hover:shadow-[0_0_30px_rgba(212,175,55,0.5)] transition transform active:scale-95 uppercase tracking-widest text-sm">
                    Enter the League
                </button>
            </form>
        </div>

        <!-- VIEW: RECORDER -->
        <div id="view-recorder" class="flex-1 flex flex-col relative hidden">
            <!-- Camera Preview -->
            <div class="relative flex-1 bg-black flex items-center justify-center overflow-hidden border-y border-gold-900/30">
                <video id="cameraPreview" autoplay playsinline muted class="absolute inset-0 w-full h-full object-cover opacity-60"></video>
                
                <div class="absolute inset-0 border-[1px] border-white/5 m-4 rounded-3xl pointer-events-none">
                    <div class="absolute top-0 left-0 w-8 h-8 border-t-2 border-l-2 border-gold-500 rounded-tl-xl"></div>
                    <div class="absolute top-0 right-0 w-8 h-8 border-t-2 border-r-2 border-gold-500 rounded-tr-xl"></div>
                    <div class="absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-gold-500 rounded-bl-xl"></div>
                    <div class="absolute bottom-0 right-0 w-8 h-8 border-b-2 border-r-2 border-gold-500 rounded-br-xl"></div>
                </div>

                <div class="z-10 text-center text-white space-y-1">
                    <div id="statusText" class="text-xs font-bold text-gold-300 uppercase tracking-[0.2em] drop-shadow-lg">Link Established</div>
                    <div id="timerDisplay" class="font-display text-5xl font-bold text-white tracking-widest drop-shadow-2xl tabular-nums">00:00:00</div>
                </div>

                <div class="absolute top-6 left-6 z-10 glass-panel px-4 py-2 rounded-lg">
                    <div id="displayStudentName" class="text-gold-100 text-sm font-bold tracking-wide">Student</div>
                    <div id="displayStudentClass" class="text-gold-500 text-[10px] uppercase tracking-widest">Class</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="h-48 bg-slate-900 z-20 flex flex-col items-center justify-center space-y-4 border-t border-white/5 relative">
                <div class="absolute inset-0 bg-gradient-to-t from-gold-900/10 to-transparent pointer-events-none"></div>

                <div id="startBtnContainer" class="relative z-10">
                    <button onclick="startRecording()" class="w-20 h-20 rounded-full border-2 border-gold-500/50 flex items-center justify-center transition transform active:scale-95 group hover:border-gold-400 shadow-[0_0_20px_rgba(212,175,55,0.1)]">
                        <div class="w-16 h-16 bg-gradient-to-br from-red-600 to-red-800 rounded-full group-hover:scale-90 transition shadow-inner"></div>
                    </button>
                    <p class="text-[10px] text-gold-500/50 uppercase tracking-widest text-center mt-3">Initiate Record</p>
                </div>

                <div id="stopBtnContainer" class="hidden flex flex-col items-center relative z-10">
                    <button onclick="stopRecording()" class="w-20 h-20 rounded-full border-2 border-gold-500/30 flex items-center justify-center pulse-gold transition transform active:scale-95 bg-slate-800">
                        <div class="w-8 h-8 bg-gold-500 rounded-sm shadow-[0_0_10px_rgba(212,175,55,0.8)]"></div>
                    </button>
                    <p class="text-[10px] text-gold-400 font-bold uppercase tracking-widest text-center mt-3 animate-pulse">Recording Active</p>
                </div>
                
                <div id="uploadingContainer" class="hidden w-full px-12 relative z-10">
                    <div class="flex justify-between text-[10px] font-bold text-gold-500 uppercase tracking-widest mb-2">
                        <span>Securing Data...</span>
                        <span id="uploadPercent">0%</span>
                    </div>
                    <div class="w-full bg-slate-800 rounded-full h-1 overflow-hidden">
                        <div id="uploadBar" class="bg-gradient-gold h-1 rounded-full transition-all duration-300 shadow-[0_0_10px_rgba(212,175,55,0.5)]" style="width: 0%"></div>
                    </div>
                    <p class="text-center text-[10px] text-gray-500 mt-3">Do not close this window</p>
                </div>
            </div>
        </div>
        
        <!-- VIEW: STUDENT STATS / PROFILE -->
        <div id="view-stats" class="absolute inset-0 bg-slate-950/95 backdrop-blur-xl z-50 transform translate-y-full transition-transform duration-500 flex flex-col">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-900/50">
                <h2 class="font-display font-bold text-xl text-white">Your Records</h2>
                <button onclick="toggleStats()" class="text-xs text-gold-500 hover:text-white transition uppercase tracking-widest font-bold">Close</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                <div class="bg-gradient-to-br from-slate-900 to-slate-800 border border-gold-500/20 rounded-xl p-6 text-center shadow-[0_0_30px_rgba(0,0,0,0.3)] mb-8">
                    <div class="text-[10px] text-gray-400 uppercase tracking-widest mb-2">Total Time Invested</div>
                    <div id="statsTotalTime" class="font-display text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-gold-100 to-gold-500">0h 0m</div>
                    <div id="statsName" class="text-sm text-gray-500 mt-2 font-medium">Student Name</div>
                </div>

                <div class="mb-8">
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="font-display font-bold text-lg text-white">Activity Log</h3>
                        <span id="statsMonth" class="text-[10px] text-gold-500 uppercase tracking-widest">Month</span>
                    </div>
                    <div class="grid grid-cols-7 gap-2 text-center text-xs text-gray-500 mb-2">
                        <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
                </div>

                <button onclick="resetProfile()" class="w-full py-4 text-xs text-red-400/70 hover:text-red-400 hover:bg-red-400/5 transition uppercase tracking-widest border border-red-900/30 rounded-lg flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Logout / Reset Profile
                </button>
            </div>
        </div>

        <!-- VIEW: LEADERBOARD -->
        <div id="view-leaderboard" class="absolute inset-0 bg-slate-950/95 backdrop-blur-xl z-50 transform translate-y-full transition-transform duration-500 flex flex-col">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-900/50">
                <div>
                    <h2 class="font-display font-bold text-xl text-gradient-gold">Hall of Fame</h2>
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest">Top 8 Scholars</p>
                </div>
                <button onclick="toggleLeaderboard()" class="text-xs text-gold-500 hover:text-white transition uppercase tracking-widest font-bold">Close</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                <div id="leaderboardList" class="space-y-3">
                    <p class="text-center text-gray-500 mt-10 text-sm">Calculating Rankings...</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-study-app';
        const COLLECTION_PATH = `artifacts/${APP_ID}/public/data/study_logs`;

        const userConfig = {
            apiKey: "AIzaSyABRykE8XBDewUfP2_Zs3umrVHr0cu1AoM",
            authDomain: "leagueoflearning-6bbf1.firebaseapp.com",
            databaseURL: "https://leagueoflearning-6bbf1-default-rtdb.firebaseio.com",
            projectId: "leagueoflearning-6bbf1",
            storageBucket: "leagueoflearning-6bbf1.firebasestorage.app",
            messagingSenderId: "1090904028266",
            appId: "1:1090904028266:web:791fb3c983d2999bbec613",
            measurementId: "G-3YNRY93R2P"
        };
        
        const firebaseConfig = userConfig || (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null);
        let db, auth, storage;

        if (firebaseConfig) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            storage = firebase.storage();
            
            if (userConfig) {
                 auth.signInAnonymously().catch(e => console.error("Anon auth failed", e));
            } else if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                auth.signInWithCustomToken(__initial_auth_token).catch(e => console.error("Auth failed", e));
            } else {
                auth.signInAnonymously().catch(e => console.error("Anon auth failed", e));
            }
        } else {
            console.error("Firebase config not found.");
        }

        // --- STATE ---
        let mediaRecorder;
        let recordedChunks = [];
        let startTime;
        let timerInterval;
        let stream;
        let recordedMimeType = null; // Store detected mime type
        
        const views = {
            profile: document.getElementById('view-profile'),
            recorder: document.getElementById('view-recorder')
        };
        
        const displays = {
            name: document.getElementById('displayStudentName'),
            class: document.getElementById('displayStudentClass')
        };

        const timerDisplay = document.getElementById('timerDisplay');

        window.onload = function() {
            checkProfile();
        };

        function checkProfile() {
            const profile = localStorage.getItem('studentProfile');
            if (profile) {
                const data = JSON.parse(profile);
                displays.name.innerText = data.name;
                displays.class.innerText = `${data.house} • ${data.class} (${data.classNo})`;
                initCamera();
                showView('recorder');
            } else {
                showView('profile');
            }
        }

        function showView(viewName) {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
        }

        function selectHouse(house) {
            document.querySelectorAll('.house-btn').forEach(btn => {
                btn.classList.remove('house-selected-Ashton', 'house-selected-Brielle', 'house-selected-Carter', 'house-selected-Dominique');
                btn.classList.remove('border-transparent');
                btn.classList.add('border-slate-700');
            });
            const btn = document.getElementById(`btn-${house}`);
            btn.classList.add(`house-selected-${house}`);
            btn.classList.remove('border-slate-700');
            btn.classList.add('border-transparent');
            document.getElementById('inputHouse').value = house;
        }

        function saveProfile(e) {
            e.preventDefault();
            const house = document.getElementById('inputHouse').value;
            if (!house) { alert("Please select a House."); return; }
            const profile = {
                name: document.getElementById('inputName').value,
                class: document.getElementById('inputClass').value,
                classNo: document.getElementById('inputClassNo').value,
                house: house
            };
            localStorage.setItem('studentProfile', JSON.stringify(profile));
            checkProfile();
        }

        function resetProfile() {
            if(confirm("Exit session?")) {
                localStorage.removeItem('studentProfile');
                if(stream) stream.getTracks().forEach(track => track.stop());
                location.reload();
            }
        }

        // --- CAMERA & RECORDING (FIXED) ---
        async function initCamera() {
            try {
                // Request standard video/audio.
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" }, 
                    audio: true 
                });
                document.getElementById('cameraPreview').srcObject = stream;
            } catch (err) {
                console.error("Camera error:", err);
                const status = document.getElementById('statusText');
                if(status) {
                    status.innerText = "Camera Access Denied";
                    status.classList.replace('text-gold-300', 'text-red-500');
                }
            }
        }

        function startRecording() {
            if (!stream) {
                alert("Camera link required. Please refresh.");
                return;
            }

            recordedChunks = [];
            
            // --- ROBUST MIME TYPE DETECTION ---
            const types = [
                "video/webm;codecs=vp8",
                "video/webm",
                "video/mp4" // Critical for Safari
            ];

            let options = null;
            recordedMimeType = ''; // Reset

            for (const type of types) {
                if (MediaRecorder.isTypeSupported(type)) {
                    recordedMimeType = type;
                    // Note: Removed videoBitsPerSecond to prevent crash on Safari if unsupported
                    options = { mimeType: type }; 
                    break;
                }
            }

            try {
                if (options) {
                    mediaRecorder = new MediaRecorder(stream, options);
                } else {
                    // Fallback to browser default
                    mediaRecorder = new MediaRecorder(stream);
                    recordedMimeType = mediaRecorder.mimeType;
                }
            } catch (e) {
                console.warn("MediaRecorder init error, trying default", e);
                mediaRecorder = new MediaRecorder(stream);
                recordedMimeType = '';
            }

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = uploadSession;
            mediaRecorder.start();
            startTime = Date.now();
            
            document.getElementById('startBtnContainer').classList.add('hidden');
            document.getElementById('stopBtnContainer').classList.remove('hidden');
            document.getElementById('statusText').innerText = "Recording Active";
            document.getElementById('statusText').classList.replace('text-gold-300', 'text-red-500');
            
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopRecording() {
            mediaRecorder.stop();
            clearInterval(timerInterval);
            document.getElementById('stopBtnContainer').classList.add('hidden');
            document.getElementById('uploadingContainer').classList.remove('hidden');
            document.getElementById('statusText').innerText = "Compressing Data...";
            document.getElementById('statusText').classList.replace('text-red-500', 'text-gold-300');
        }

        function updateTimer() {
            const diff = Date.now() - startTime;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            timerDisplay.innerText = 
                `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
        }

        // --- UPLOAD LOGIC (FIXED) ---
        async function uploadSession() {
            const durationMs = Date.now() - startTime;
            const profile = JSON.parse(localStorage.getItem('studentProfile'));

            const sessionData = {
                studentName: profile.name,
                studentClass: profile.class,
                classNo: profile.classNo,
                house: profile.house,
                durationMs: durationMs,
                timestamp: new Date().toISOString(),
                videoUrl: null
            };

            if (recordedChunks.length === 0) {
                saveLogToFirestore(sessionData);
                return;
            }

            // Create Blob with detected MimeType
            const type = recordedMimeType || 'video/webm'; 
            const blob = new Blob(recordedChunks, { type: type });
            
            // Determine Extension
            const ext = type.includes('mp4') ? 'mp4' : 'webm';

            // TIMEOUT FAILSAFE: 15 Seconds
            let uploadCompleted = false;
            const safetyTimeout = setTimeout(() => {
                if (!uploadCompleted) {
                    uploadCompleted = true;
                    console.warn("Upload timed out - saving stats only");
                    document.getElementById('statusText').innerText = "Network Slow - Stats Saved";
                    saveLogToFirestore(sessionData);
                }
            }, 15000);

            try {
                if (storage) {
                    const filename = `study_${Date.now()}_${profile.class}_${profile.classNo}.${ext}`;
                    const storageRef = storage.ref().child('study_videos/' + filename);
                    const uploadTask = storageRef.put(blob);

                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            document.getElementById('uploadBar').style.width = progress + '%';
                            document.getElementById('uploadPercent').innerText = Math.round(progress) + '%';
                        }, 
                        (error) => {
                            console.error("Storage upload error", error);
                            if (!uploadCompleted) {
                                uploadCompleted = true;
                                clearTimeout(safetyTimeout);
                                saveLogToFirestore(sessionData);
                            }
                        }, 
                        async () => {
                            if (!uploadCompleted) {
                                uploadCompleted = true;
                                clearTimeout(safetyTimeout);
                                try {
                                    const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                    sessionData.videoUrl = downloadURL;
                                } catch(e) { console.warn("Could not get URL"); }
                                saveLogToFirestore(sessionData);
                            }
                        }
                    );
                } else {
                    if(!uploadCompleted) {
                        uploadCompleted = true;
                        clearTimeout(safetyTimeout);
                        saveLogToFirestore(sessionData);
                    }
                }
            } catch (err) {
                console.error("Upload error:", err);
                if(!uploadCompleted) {
                    uploadCompleted = true;
                    clearTimeout(safetyTimeout);
                    saveLogToFirestore(sessionData);
                }
            }
        }

        async function saveLogToFirestore(data) {
            try {
                if (db) {
                    await db.collection(COLLECTION_PATH).add(data);
                }
                finishSession();
            } catch (e) {
                console.error("DB Error:", e);
                alert("Offline Mode: Stats Saved Locally.");
                finishSession();
            }
        }

        function finishSession() {
            setTimeout(() => {
                document.getElementById('uploadingContainer').classList.add('hidden');
                document.getElementById('startBtnContainer').classList.remove('hidden');
                document.getElementById('uploadBar').style.width = '0%';
                document.getElementById('uploadPercent').innerText = '0%';
                document.getElementById('statusText').innerText = "Link Established";
                timerDisplay.innerText = "00:00:00";
                alert("Session Logged. Honor to your House.");
            }, 1000);
        }

        // --- OVERLAYS ---
        function toggleLeaderboard() {
            const panel = document.getElementById('view-leaderboard');
            const isOpen = !panel.classList.contains('translate-y-full');
            if(!document.getElementById('view-stats').classList.contains('translate-y-full')){
                document.getElementById('view-stats').classList.add('translate-y-full');
            }
            if (isOpen) {
                panel.classList.add('translate-y-full');
            } else {
                panel.classList.remove('translate-y-full');
                fetchLeaderboard();
            }
        }

        async function fetchLeaderboard() {
            if (!db) return;
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '<div class="flex justify-center p-4"><div class="w-6 h-6 border-2 border-gold-500 border-t-transparent rounded-full animate-spin"></div></div>';
            try {
                const snapshot = await db.collection(COLLECTION_PATH).get();
                const studentTotals = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.studentName && data.durationMs) {
                        const key = `${data.studentName} (${data.studentClass})`;
                        if(!studentTotals[key]) {
                            studentTotals[key] = { name: data.studentName, house: data.house, class: data.studentClass, totalMs: 0 };
                        }
                        studentTotals[key].totalMs += data.durationMs;
                    }
                });
                const leaderboard = Object.values(studentTotals).sort((a, b) => b.totalMs - a.totalMs).slice(0, 8);
                list.innerHTML = '';
                if(leaderboard.length === 0) { list.innerHTML = '<p class="text-center text-gray-500 text-xs tracking-widest mt-4">No Records Yet</p>'; return; }
                leaderboard.forEach((student, index) => {
                    const totalHours = (student.totalMs / 3600000).toFixed(1);
                    const rankColor = index === 0 ? 'text-yellow-400' : (index === 1 ? 'text-gray-300' : (index === 2 ? 'text-amber-700' : 'text-gray-500'));
                    const borderColor = index === 0 ? 'border-yellow-500/50' : 'border-white/5';
                    const el = document.createElement('div');
                    el.className = `bg-slate-900/50 p-3 rounded-lg border ${borderColor} flex items-center justify-between`;
                    el.innerHTML = `<div class="flex items-center gap-3"><div class="font-display font-bold text-lg w-6 text-center ${rankColor}">#${index + 1}</div><div><div class="font-bold text-gray-200 text-sm">${student.name}</div><div class="text-[10px] text-gray-500 uppercase tracking-wide">${student.house} • ${student.class}</div></div></div><div class="text-right"><div class="font-display font-bold text-gold-500">${totalHours}<span class="text-[10px] text-gray-600 ml-1">HRS</span></div></div>`;
                    list.appendChild(el);
                });
            } catch (error) { list.innerHTML = '<p class="text-center text-red-500 text-xs">Connection Failed</p>'; }
        }

        function toggleStats() {
            const panel = document.getElementById('view-stats');
            const isOpen = !panel.classList.contains('translate-y-full');
            if(!document.getElementById('view-leaderboard').classList.contains('translate-y-full')){
                document.getElementById('view-leaderboard').classList.add('translate-y-full');
            }
            if (isOpen) { panel.classList.add('translate-y-full'); } else { panel.classList.remove('translate-y-full'); loadStudentStats(); }
        }

        async function loadStudentStats() {
            const profile = JSON.parse(localStorage.getItem('studentProfile'));
            if (!profile || !db) return;
            document.getElementById('statsName').innerText = profile.name;
            document.getElementById('statsTotalTime').innerText = "Loading...";
            try {
                const snapshot = await db.collection(COLLECTION_PATH).get();
                let totalMs = 0;
                const dailyActivity = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.studentName === profile.name && data.studentClass === profile.class) {
                        totalMs += data.durationMs;
                        const date = new Date(data.timestamp);
                        const dateKey = date.toISOString().split('T')[0];
                        dailyActivity[dateKey] = (dailyActivity[dateKey] || 0) + data.durationMs;
                    }
                });
                const hours = Math.floor(totalMs / 3600000);
                const minutes = Math.floor((totalMs % 3600000) / 60000);
                document.getElementById('statsTotalTime').innerText = `${hours}h ${minutes}m`;
                renderCalendar(dailyActivity);
            } catch (e) { document.getElementById('statsTotalTime').innerText = "Error"; }
        }

        function renderCalendar(activityMap) {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
            document.getElementById('statsMonth').innerText = `${monthNames[month]} ${year}`;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayIndex = new Date(year, month, 1).getDay();
            for (let i = 0; i < firstDayIndex; i++) { grid.appendChild(document.createElement('div')); }
            for (let d = 1; d <= daysInMonth; d++) {
                const dayStr = String(d).padStart(2, '0');
                const monthStr = String(month + 1).padStart(2, '0');
                const dateKey = `${year}-${monthStr}-${dayStr}`;
                const ms = activityMap[dateKey] || 0;
                const el = document.createElement('div');
                el.className = "aspect-square flex items-center justify-center rounded-md text-xs font-medium transition relative group";
                el.innerText = d;
                if (ms > 0) {
                    if (ms > 7200000) el.classList.add('bg-gold-500', 'text-slate-900', 'font-bold');
                    else if (ms > 3600000) el.classList.add('bg-gold-700', 'text-white');
                    else el.classList.add('bg-gold-900/40', 'text-gold-100', 'border', 'border-gold-500/30');
                    const mins = Math.round(ms / 60000);
                    el.innerHTML += `<div class="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 bg-black text-white text-[10px] px-2 py-1 rounded hidden group-hover:block whitespace-nowrap z-10 pointer-events-none">${mins} mins</div>`;
                } else { el.classList.add('bg-slate-800/50', 'text-gray-600'); }
                grid.appendChild(el);
            }
        }
    </script>
</body>
</html>
